name: Deploy Flutter Web

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build libgtk-3-dev
        flutter pub get
    
    - name: Build web
      run: |
        flutter clean
        flutter build web --release
    
    - name: Create Vercel config
      run: |
        echo '{"rewrites":[{"source":"/(.*)","destination":"/index.html"}]}' > build/web/vercel.json
    
    - name: Setup Node.js and install Vercel CLI
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install Vercel CLI globally
      run: npm install -g vercel@latest
    
    - name: Deploy to Vercel
      run: |
        cd build/web
        vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes